{
  "rules": {
    ".read": false,
    ".write": false,

    "users": {
      ".read": "auth != null",
      ".indexOn": ["email"],
      "$uid": {
        ".write": "auth != null && auth.uid === $uid",
        ".validate": "newData.hasChildren(['uid', 'displayName', 'email', 'online', 'lastSeen', 'createdAt']) && newData.child('uid').val() === $uid && newData.child('displayName').isString() && newData.child('email').isString() && newData.child('online').isBoolean() && (newData.child('lastSeen').isNumber() || newData.child('lastSeen').child('.sv').val() === 'timestamp') && newData.child('createdAt').isNumber()"
      }
    },

    "blockedUsers": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        ".write": "auth != null && auth.uid === $uid",
        "$blockedUid": {
          ".validate": "!newData.exists() || newData.val() === true"
        }
      }
    },

    "blockedBy": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        "$blockerUid": {
          ".write": "auth != null && auth.uid === $blockerUid",
          ".validate": "!newData.exists() || newData.val() === true"
        }
      }
    },

    "contacts": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        "$contactUid": {
          ".write": "auth != null && (auth.uid === $uid || auth.uid === $contactUid)",
          ".validate": "newData.val() === true"
        }
      }
    },

    "contactRequests": {
      "$targetUid": {
        ".read": "auth != null && auth.uid === $targetUid",
        "$senderUid": {
          ".read": "auth != null && auth.uid === $senderUid",
          ".write": "auth != null && (auth.uid === $senderUid || auth.uid === $targetUid) && (!newData.exists() || (!root.child('blockedUsers').child($targetUid).child($senderUid).exists() && !root.child('blockedUsers').child($senderUid).child($targetUid).exists()))",
          ".validate": "newData.hasChildren(['from', 'fromName', 'fromEmail', 'to', 'timestamp', 'status']) && newData.child('from').val() === $senderUid && newData.child('to').val() === $targetUid && newData.child('fromName').isString() && newData.child('fromEmail').isString() && newData.child('timestamp').isNumber() && newData.child('status').val() === 'pending'"
        }
      }
    },

    "chats": {
      ".read": "auth != null",
      "$chatId": {
        ".write": "auth != null && (!data.exists() || data.child('members').child(auth.uid).exists())",
        ".validate": "!newData.exists() || (newData.hasChildren(['type', 'members', 'createdBy', 'createdAt']) && (newData.child('type').val() === 'direct' || newData.child('type').val() === 'group') && newData.child('createdBy').isString() && newData.child('createdAt').isNumber())",
        "members": {
          "$uid": {
            ".write": "auth != null && ((auth.uid === $uid && data.exists() && !newData.exists()) || (auth.uid === $uid && !data.exists() && newData.val() === true && data.parent().parent().child('pendingMembers').child($uid).child('type').val() === 'invite') || data.parent().parent().child('admins').child(auth.uid).exists())",
            ".validate": "!newData.exists() || newData.val() === true"
          }
        },
        "admins": {
          "$uid": {
            ".write": "auth != null && (!data.parent().parent().exists() || data.parent().child(auth.uid).exists() || (auth.uid === $uid && !newData.exists()))",
            ".validate": "!newData.exists() || newData.val() === true"
          }
        },
        "pendingMembers": {
          "$uid": {
            ".write": "auth != null && (auth.uid === $uid || data.parent().parent().child('admins').child(auth.uid).exists() || data.parent().parent().child('members').child(auth.uid).exists())",
            ".validate": "newData.hasChildren(['type', 'fromUid', 'fromName', 'timestamp']) && (newData.child('type').val() === 'invite' || newData.child('type').val() === 'request') && newData.child('fromUid').isString() && newData.child('fromName').isString() && newData.child('timestamp').isNumber()"
          }
        },
        "typing": {
          "$uid": {
            ".validate": "auth.uid === $uid && newData.isBoolean()"
          }
        },
        "encryptedGroupKey": {
          "$uid": {
            ".validate": "newData.hasChildren(['wrappedKey', 'iv', 'wrappedBy'])"
          }
        }
      }
    },

    "messages": {
      "$chatId": {
        ".read": "auth != null && root.child('chats').child($chatId).child('members').child(auth.uid).exists()",
        ".write": "auth != null && root.child('chats').child($chatId).child('members').child(auth.uid).exists()",
        ".indexOn": ["timestamp"],
        "$msgId": {
          ".validate": "newData.hasChildren(['chatId', 'senderId', 'senderName', 'text', 'timestamp', 'type']) && newData.child('chatId').val() === $chatId && newData.child('senderName').isString() && newData.child('text').isString() && newData.child('timestamp').isNumber() && (newData.child('type').val() === 'text' || newData.child('type').val() === 'image' || newData.child('type').val() === 'gif' || newData.child('type').val() === 'sticker' || newData.child('type').val() === 'voice' || newData.child('type').val() === 'system') && (data.exists() ? newData.child('senderId').val() === data.child('senderId').val() : (newData.child('senderId').val() === auth.uid || newData.child('senderId').val() === 'system'))",
          "readBy": {
            "$uid": {
              ".validate": "auth.uid === $uid && newData.val() === true"
            }
          }
        }
      }
    },

    "calls": {
      ".read": "auth != null",
      ".indexOn": ["status"],
      "$callId": {
        ".write": "auth != null && (!data.exists() || data.child('participants').child(auth.uid).exists())",
        ".validate": "newData.hasChildren(['chatId', 'callerId', 'callerName', 'callType', 'status', 'participants', 'createdAt']) && newData.child('chatId').isString() && newData.child('callerName').isString() && (newData.child('callType').val() === 'audio' || newData.child('callType').val() === 'video') && (newData.child('status').val() === 'ringing' || newData.child('status').val() === 'active' || newData.child('status').val() === 'ended') && newData.child('participants').child(auth.uid).exists() && newData.child('createdAt').isNumber()",
        "callerId": {
          ".validate": "(data.exists() && newData.val() === data.val()) || (!data.exists() && newData.val() === auth.uid)"
        }
      }
    },

    "callSignaling": {
      "$callId": {
        ".read": "auth != null && root.child('calls').child($callId).child('participants').child(auth.uid).exists()",
        ".write": "auth != null && root.child('calls').child($callId).child('participants').child(auth.uid).exists()"
      }
    },

    "privateKeys": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        ".write": "auth != null && auth.uid === $uid",
        ".validate": "newData.hasChildren(['encryptedPrivateKey']) && newData.child('encryptedPrivateKey').hasChildren(['ciphertext', 'iv', 'salt'])"
      }
    },

    "pushSubscriptions": {
      "$uid": {
        ".read": "auth != null",
        ".write": "auth != null && auth.uid === $uid"
      }
    },

    "yapps": {
      ".read": "auth != null",
      ".indexOn": ["timestamp", "authorId", "parentId"],
      "$yappId": {
        ".write": "auth != null && (!data.exists() || data.child('authorId').val() === auth.uid)",
        ".validate": "newData.hasChildren(['id', 'authorId', 'authorName', 'text', 'timestamp', 'likeCount', 'replyCount', 'reyappCount', 'privacy']) && (data.exists() || newData.child('authorId').val() === auth.uid) && newData.child('authorId').isString() && newData.child('authorName').isString() && newData.child('text').isString() && newData.child('timestamp').isNumber() && newData.child('likeCount').isNumber() && newData.child('replyCount').isNumber() && newData.child('reyappCount').isNumber() && (newData.child('privacy').val() === 'public' || newData.child('privacy').val() === 'contacts')",
        "likeCount": {
          ".write": "auth != null",
          ".validate": "newData.isNumber() && (newData.val() === data.val() + 1 || newData.val() === data.val() - 1 || !data.exists())"
        },
        "replyCount": {
          ".write": "auth != null",
          ".validate": "newData.isNumber() && (newData.val() === data.val() + 1 || newData.val() === data.val() - 1 || !data.exists())"
        },
        "reyappCount": {
          ".write": "auth != null",
          ".validate": "newData.isNumber() && (newData.val() === data.val() + 1 || newData.val() === data.val() - 1 || !data.exists())"
        }
      }
    },

    "yappLikes": {
      ".read": "auth != null",
      "$yappId": {
        ".write": "auth != null && root.child('yapps').child($yappId).child('authorId').val() === auth.uid",
        "$uid": {
          ".write": "auth != null && auth.uid === $uid",
          ".validate": "!newData.exists() || newData.val() === true"
        }
      }
    },

    "yappFollowing": {
      "$uid": {
        ".read": "auth != null",
        ".write": "auth != null && auth.uid === $uid",
        "$targetUid": {
          ".validate": "!newData.exists() || (newData.val() === true && !root.child('blockedUsers').child($uid).child($targetUid).exists() && !root.child('blockedUsers').child($targetUid).child($uid).exists())"
        }
      }
    },

    "yappFollowers": {
      "$uid": {
        ".read": "auth != null",
        "$followerUid": {
          ".write": "auth != null && auth.uid === $followerUid",
          ".validate": "!newData.exists() || (newData.val() === true && !root.child('blockedUsers').child($uid).child($followerUid).exists() && !root.child('blockedUsers').child($followerUid).child($uid).exists())"
        }
      }
    },

    "yappsSettings": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        ".write": "auth != null && auth.uid === $uid"
      }
    }
  }
}
